"""System Settings handlers for bot configuration and maintenance."""
import logging
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from database import get_db_session, close_db_session
from database.operations import SystemSettingsService, ActivityLogService
from utils.helpers import is_admin

logger = logging.getLogger(__name__)


async def handle_admin_settings(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Main System Settings panel."""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if not is_admin(user.id):
        await query.edit_message_text('‚ùå Access denied.')
        return
    
    db = get_db_session()
    try:
        # Get current settings from database
        settings = SystemSettingsService.get_all_settings(db)
        
        # Get system info
        from database.models import User, TelegramAccount, ActivityLog
        total_users = db.query(User).count()
        total_accounts = db.query(TelegramAccount).count()
        total_logs = db.query(ActivityLog).count()
        
        text = f"""
‚öôÔ∏è **SYSTEM SETTINGS & CONFIGURATION**

**üìä SYSTEM STATUS:**
‚Ä¢ Total Users: {total_users}
‚Ä¢ Total Accounts: {total_accounts}
‚Ä¢ Activity Logs: {total_logs}

**üîß CURRENT CONFIGURATION:**
‚Ä¢ Verification Required: {settings.get('verification_required', 'true')}
‚Ä¢ Default Freeze Duration: {settings.get('default_freeze_hours', '24')}h
‚Ä¢ Min Withdrawal Amount: ${settings.get('min_withdrawal', '10.00')}
‚Ä¢ Commission Rate: {settings.get('commission_rate', '10')}%
‚Ä¢ Max Daily Sales/User: {settings.get('max_daily_sales', '10')}

**‚ö° QUICK ACTIONS:**
Configure bot behavior, manage system maintenance, and control security settings.
        """
        
        keyboard = [
            [InlineKeyboardButton("üîß Bot Configuration", callback_data="settings_bot_config")],
            [InlineKeyboardButton("üí∞ Financial Settings", callback_data="settings_financial")],
            [InlineKeyboardButton("üîê Security & Access", callback_data="settings_security")],
            [InlineKeyboardButton("üßπ System Maintenance", callback_data="settings_maintenance")],
            [InlineKeyboardButton("üîô Back to Admin", callback_data="admin_panel")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(text, parse_mode='Markdown', reply_markup=reply_markup)
        
    finally:
        close_db_session(db)


async def handle_settings_bot_config(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Bot configuration settings."""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if not is_admin(user.id):
        await query.edit_message_text('‚ùå Access denied.')
        return
    
    db = get_db_session()
    try:
        settings = SystemSettingsService.get_all_settings(db)
        
        verification_required = settings.get('verification_required', 'true') == 'true'
        captcha_enabled = settings.get('captcha_enabled', 'true') == 'true'
        channel_verification = settings.get('channel_verification_required', 'true') == 'true'
        default_freeze_hours = settings.get('default_freeze_hours', '24')
        max_daily_sales = settings.get('max_daily_sales', '10')
        
        text = f"""
üîß **BOT CONFIGURATION**

**üìã VERIFICATION SETTINGS:**
‚Ä¢ Verification Required: {'‚úÖ Enabled' if verification_required else '‚ùå Disabled'}
‚Ä¢ CAPTCHA Enabled: {'‚úÖ Enabled' if captcha_enabled else '‚ùå Disabled'}
‚Ä¢ Channel Join Required: {'‚úÖ Enabled' if channel_verification else '‚ùå Disabled'}

**‚öôÔ∏è OPERATIONAL SETTINGS:**
‚Ä¢ Default Freeze Duration: {default_freeze_hours} hours
‚Ä¢ Max Daily Sales/User: {max_daily_sales}

**‚ÑπÔ∏è CONFIGURATION INFO:**
These settings control core bot behavior. Changes take effect immediately.
        """
        
        keyboard = [
            [InlineKeyboardButton(
                f"{'‚ùå Disable' if verification_required else '‚úÖ Enable'} Verification",
                callback_data="toggle_verification"
            )],
            [InlineKeyboardButton(
                f"{'‚ùå Disable' if captcha_enabled else '‚úÖ Enable'} CAPTCHA",
                callback_data="toggle_captcha"
            )],
            [InlineKeyboardButton(
                f"{'‚ùå Disable' if channel_verification else '‚úÖ Enable'} Channel Join",
                callback_data="toggle_channel_verification"
            )],
            [InlineKeyboardButton("‚è±Ô∏è Set Freeze Duration", callback_data="set_freeze_duration")],
            [InlineKeyboardButton("üìä Set Daily Limit", callback_data="set_daily_limit")],
            [InlineKeyboardButton("üîô Back", callback_data="admin_settings")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(text, parse_mode='Markdown', reply_markup=reply_markup)
        
    finally:
        close_db_session(db)


async def handle_settings_financial(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Financial settings panel."""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if not is_admin(user.id):
        await query.edit_message_text('‚ùå Access denied.')
        return
    
    db = get_db_session()
    try:
        settings = SystemSettingsService.get_all_settings(db)
        
        min_withdrawal = settings.get('min_withdrawal', '10.00')
        commission_rate = settings.get('commission_rate', '10')
        min_account_price = settings.get('min_account_price', '1.00')
        max_account_price = settings.get('max_account_price', '1000.00')
        
        text = f"""
üí∞ **FINANCIAL SETTINGS**

**üè¶ WITHDRAWAL CONFIGURATION:**
‚Ä¢ Minimum Withdrawal: ${min_withdrawal}
‚Ä¢ Current Commission Rate: {commission_rate}%

**üíµ ACCOUNT PRICING:**
‚Ä¢ Minimum Price: ${min_account_price}
‚Ä¢ Maximum Price: ${max_account_price}

**üìä FINANCIAL CONTROLS:**
Configure pricing limits, commission rates, and withdrawal thresholds.
        """
        
        keyboard = [
            [InlineKeyboardButton("üíµ Set Min Withdrawal", callback_data="set_min_withdrawal")],
            [InlineKeyboardButton("üìà Set Commission Rate", callback_data="set_commission")],
            [InlineKeyboardButton("üí≤ Set Price Limits", callback_data="set_price_limits")],
            [InlineKeyboardButton("üîô Back", callback_data="admin_settings")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(text, parse_mode='Markdown', reply_markup=reply_markup)
        
    finally:
        close_db_session(db)


async def handle_settings_security(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Security and access control settings."""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if not is_admin(user.id):
        await query.edit_message_text('‚ùå Access denied.')
        return
    
    db = get_db_session()
    try:
        # Get admin/leader count
        from database.models import User
        admin_count = db.query(User).filter(User.is_admin == True).count()
        leader_count = db.query(User).filter(User.is_leader == True).count()
        
        # Get environment variables for current access control
        admin_ids = os.getenv('ADMIN_USER_ID', 'Not set')
        leader_channel = os.getenv('LEADER_CHANNEL_ID', 'Not set')
        
        settings = SystemSettingsService.get_all_settings(db)
        max_login_attempts = settings.get('max_login_attempts', '3')
        session_timeout = settings.get('session_timeout_minutes', '60')
        
        text = f"""
üîê **SECURITY & ACCESS CONTROL**

**üëë PRIVILEGED USERS:**
‚Ä¢ Active Admins: {admin_count}
‚Ä¢ Active Leaders: {leader_count}

**üîß ENVIRONMENT CONFIGURATION:**
‚Ä¢ Admin User IDs: {admin_ids}
‚Ä¢ Leader Channel ID: {leader_channel}

**‚öôÔ∏è SECURITY SETTINGS:**
‚Ä¢ Max Login Attempts: {max_login_attempts}
‚Ä¢ Session Timeout: {session_timeout} minutes

**‚ÑπÔ∏è NOTE:**
Admin and Leader access is controlled via environment variables (ADMIN_USER_ID, LEADER_CHANNEL_ID) and can be managed in the Manual User Edit panel.
        """
        
        keyboard = [
            [InlineKeyboardButton("üë• View All Admins", callback_data="view_all_admins")],
            [InlineKeyboardButton("üë• View All Leaders", callback_data="view_all_leaders")],
            [InlineKeyboardButton("üîí Set Login Attempts", callback_data="set_login_attempts")],
            [InlineKeyboardButton("‚è±Ô∏è Set Session Timeout", callback_data="set_session_timeout")],
            [InlineKeyboardButton("üîô Back", callback_data="admin_settings")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(text, parse_mode='Markdown', reply_markup=reply_markup)
        
    finally:
        close_db_session(db)


async def handle_settings_maintenance(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """System maintenance panel."""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if not is_admin(user.id):
        await query.edit_message_text('‚ùå Access denied.')
        return
    
    db = get_db_session()
    try:
        # Get system statistics
        from database.models import User, TelegramAccount, ActivityLog, AccountSale, Withdrawal
        
        total_logs = db.query(ActivityLog).count()
        total_inactive_accounts = db.query(TelegramAccount).filter(
            TelegramAccount.status == 'inactive'
        ).count()
        completed_sales = db.query(AccountSale).count()
        completed_withdrawals = db.query(Withdrawal).filter(
            Withdrawal.status == 'COMPLETED'
        ).count()
        
        text = f"""
üßπ **SYSTEM MAINTENANCE**

**üìä DATABASE STATISTICS:**
‚Ä¢ Activity Logs: {total_logs} entries
‚Ä¢ Inactive Accounts: {total_inactive_accounts}
‚Ä¢ Completed Sales: {completed_sales}
‚Ä¢ Completed Withdrawals: {completed_withdrawals}

**üîß MAINTENANCE ACTIONS:**
Perform system cleanup, optimize database, and manage old records.

**‚ö†Ô∏è WARNING:**
Some maintenance actions are irreversible. Use with caution.
        """
        
        keyboard = [
            [InlineKeyboardButton("üóëÔ∏è Clear Old Activity Logs", callback_data="clear_old_logs")],
            [InlineKeyboardButton("üßπ Clean Inactive Accounts", callback_data="clean_inactive_accounts")],
            [InlineKeyboardButton("üìä Database Statistics", callback_data="view_db_stats")],
            [InlineKeyboardButton("üîÑ Optimize Database", callback_data="optimize_database")],
            [InlineKeyboardButton("üîô Back", callback_data="admin_settings")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(text, parse_mode='Markdown', reply_markup=reply_markup)
        
    finally:
        close_db_session(db)


async def handle_toggle_verification(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Toggle verification requirement."""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if not is_admin(user.id):
        return
    
    db = get_db_session()
    try:
        current = SystemSettingsService.get_setting(db, 'verification_required', 'true')
        new_value = 'false' if current == 'true' else 'true'
        SystemSettingsService.set_setting(db, 'verification_required', new_value)
        
        await query.answer(f"‚úÖ Verification {'disabled' if new_value == 'false' else 'enabled'}!", show_alert=True)
        await handle_settings_bot_config(update, context)
        
    finally:
        close_db_session(db)


async def handle_toggle_captcha(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Toggle CAPTCHA requirement."""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if not is_admin(user.id):
        return
    
    db = get_db_session()
    try:
        current = SystemSettingsService.get_setting(db, 'captcha_enabled', 'true')
        new_value = 'false' if current == 'true' else 'true'
        SystemSettingsService.set_setting(db, 'captcha_enabled', new_value)
        
        await query.answer(f"‚úÖ CAPTCHA {'disabled' if new_value == 'false' else 'enabled'}!", show_alert=True)
        await handle_settings_bot_config(update, context)
        
    finally:
        close_db_session(db)


async def handle_toggle_channel_verification(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Toggle channel verification requirement."""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if not is_admin(user.id):
        return
    
    db = get_db_session()
    try:
        current = SystemSettingsService.get_setting(db, 'channel_verification_required', 'true')
        new_value = 'false' if current == 'true' else 'true'
        SystemSettingsService.set_setting(db, 'channel_verification_required', new_value)
        
        await query.answer(f"‚úÖ Channel verification {'disabled' if new_value == 'false' else 'enabled'}!", show_alert=True)
        await handle_settings_bot_config(update, context)
        
    finally:
        close_db_session(db)


async def handle_clear_old_logs(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Clear activity logs older than 90 days."""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if not is_admin(user.id):
        return
    
    db = get_db_session()
    try:
        from datetime import datetime, timedelta, timezone
        from database.models import ActivityLog
        
        # Delete logs older than 90 days
        cutoff_date = datetime.now(timezone.utc) - timedelta(days=90)
        deleted = db.query(ActivityLog).filter(ActivityLog.created_at < cutoff_date).delete()
        db.commit()
        
        await query.answer(f"‚úÖ Deleted {deleted} old activity logs!", show_alert=True)
        await handle_settings_maintenance(update, context)
        
    except Exception as e:
        logger.error(f"Error clearing logs: {e}")
        await query.answer(f"‚ùå Error: {str(e)}", show_alert=True)
    finally:
        close_db_session(db)


async def handle_view_db_stats(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """View detailed database statistics."""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if not is_admin(user.id):
        return
    
    db = get_db_session()
    try:
        from database.models import User, TelegramAccount, ActivityLog, AccountSale, Withdrawal, ProxyPool
        
        stats = {
            'Users': db.query(User).count(),
            'Telegram Accounts': db.query(TelegramAccount).count(),
            'Activity Logs': db.query(ActivityLog).count(),
            'Account Sales': db.query(AccountSale).count(),
            'Withdrawals': db.query(Withdrawal).count(),
            'Proxies': db.query(ProxyPool).count()
        }
        
        text = "üìä **DATABASE STATISTICS**\n\n"
        for table, count in stats.items():
            text += f"‚Ä¢ {table}: {count:,} records\n"
        
        keyboard = [[InlineKeyboardButton("üîô Back", callback_data="settings_maintenance")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(text, parse_mode='Markdown', reply_markup=reply_markup)
        
    finally:
        close_db_session(db)
